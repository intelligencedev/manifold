# Manifold Enterprise Configuration
# =================================
# This configuration enables all enterprise features:
# - S3/MinIO object storage with encryption
# - Redis for distributed coordination
# - Kafka for durable event streaming
# - HashiCorp Vault for key management
# - Encrypted local cache with tmpfs working set
#
# See docs/deployment.md for detailed deployment instructions.

# Authentication (recommended for production)
auth:
  enabled: true
  provider: oidc
  issuerURL: "${AUTH_ISSUER_URL}"
  clientID: "${AUTH_CLIENT_ID}"
  clientSecret: "${AUTH_CLIENT_SECRET}"
  redirectURL: "${AUTH_REDIRECT_URL:-http://localhost:32180/auth/callback}"
  allowedDomains: []
  cookieName: "manifold_session"
  cookieSecure: true  # Enable for HTTPS
  cookieDomain: ""
  stateTTLSeconds: 600
  sessionTTLHours: 72

# LLM Provider Configuration
llm_client:
  provider: openai
  openai:
    api: completions
    summaryBaseURL: "${OPENAI_BASE_URL:-https://api.openai.com/v1}"
    summaryModel: "${SUMMARY_MODEL:-gpt-4o-mini}"
    extraParams:
      parallel_tool_calls: true

# Agent runtime configuration
maxSteps: 1000
maxToolParallelism: 4  # Bounded parallelism for predictable resource usage
agentRunTimeoutSeconds: 300
streamRunTimeoutSeconds: 600
workflowTimeoutSeconds: 1800

# Summarization (token-based)
summaryEnabled: true
summaryReserveBufferTokens: 25000
summaryMinKeepLastMessages: 4
summaryMaxSummaryChunkTokens: 4096

# Tokenization (accurate token counting)
tokenization:
  enabled: true
  cacheSize: 10000
  cacheTTLSeconds: 3600
  fallbackToHeuristic: true

# ===================
# Enterprise Features
# ===================

# Projects Storage Configuration
projects:
  # Backend: S3 for durable, scalable storage
  backend: s3
  
  # Enable at-rest encryption (envelope encryption with Vault-managed KEK)
  encrypt: true
  
  # Key Provider: HashiCorp Vault Transit engine
  encryption:
    provider: vault
    vault:
      address: "${VAULT_ADDR:-http://vault:8200}"
      token: "${VAULT_TOKEN}"
      keyName: "${VAULT_KEY_NAME:-manifold-kek}"
      mountPath: "transit"
      namespace: ""  # Set for Vault Enterprise namespaces
      tlsSkipVerify: false  # Set true only for dev
      timeoutSeconds: 30
  
  # Workspace: Ephemeral mode with encrypted cache
  workspace:
    mode: ephemeral
    root: "${WORKDIR}/sandboxes"
    ttlSeconds: 86400  # 24 hours
    # Encrypted cache (ciphertext on disk)
    cacheDir: "${PROJECTS_WORKSPACE_CACHE_DIR:-/app/cache}"
    # tmpfs (plaintext in RAM only)
    tmpfsDir: "${PROJECTS_WORKSPACE_TMPFS_DIR:-/app/tmpfs}"
  
  # S3/MinIO Configuration
  s3:
    endpoint: "${PROJECTS_S3_ENDPOINT:-http://minio:9000}"
    region: "${PROJECTS_S3_REGION:-us-east-1}"
    bucket: "${PROJECTS_S3_BUCKET:-manifold-workspaces}"
    prefix: "workspaces"
    accessKey: "${PROJECTS_S3_ACCESS_KEY}"
    secretKey: "${PROJECTS_S3_SECRET_KEY}"
    usePathStyle: true  # Required for MinIO
    tlsInsecureSkipVerify: false
    sse:
      mode: none  # S3 SSE (optional, in addition to client-side encryption)
  
  # Redis: Generation cache, locks, pub/sub invalidation
  redis:
    enabled: true
    addr: "${REDIS_ADDR:-redis:6379}"
    password: "${REDIS_PASSWORD:-}"
    db: 0
    tlsInsecureSkipVerify: false
  
  # Kafka: Durable commit events for audit trail
  events:
    enabled: true
    brokers: "${KAFKA_BROKERS:-kafka:29092}"
    topic: "${PROJECTS_KAFKA_TOPIC:-manifold.project.commits}"

# Skills Configuration
skills:
  redisCacheTTLSeconds: 3600  # 1 hour cache for rendered prompts
  useS3Loader: true  # Direct S3 fetch without full workspace hydration

# Observability
obs:
  serviceName: manifold
  environment: "${ENVIRONMENT:-production}"
  otlp: "${OTLP_ENDPOINT:-http://otel-collector:4318}"
  clickhouse:
    dsn: "${CLICKHOUSE_DSN:-tcp://clickhouse:9000?database=otel}"
    metricsTable: metrics_sum
    tracesTable: traces
    logsTable: logs
    timestampColumn: TimeUnix
    valueColumn: Value
    modelAttributeKey: llm.model
    promptMetricName: llm.prompt_tokens
    completionMetricName: llm.completion_tokens
    lookbackHours: 24
    timeoutSeconds: 5

# Database connections
databases:
  defaultDSN: "${DATABASE_URL:-postgres://manifold:manifold@pg-manifold:5432/manifold?sslmode=disable}"
  chat:
    backend: postgres
    dsn: "${DATABASE_URL:-postgres://manifold:manifold@pg-manifold:5432/manifold?sslmode=disable}"
  search:
    backend: postgres
    dsn: "${DATABASE_URL:-postgres://manifold:manifold@pg-manifold:5432/manifold?sslmode=disable}"
  vector:
    backend: postgres
    dsn: "${DATABASE_URL:-postgres://manifold:manifold@pg-manifold:5432/manifold?sslmode=disable}"
    metric: cosine
  graph:
    backend: postgres
    dsn: "${DATABASE_URL:-postgres://manifold:manifold@pg-manifold:5432/manifold?sslmode=disable}"

# Embedding service (for vector operations and evolving memory)
embedding:
  baseURL: "${EMBEDDING_URL:-http://localhost:11434}"
  model: "${EMBEDDING_MODEL:-nomic-embed-text}"
  path: "/api/embeddings"
  timeoutSeconds: 30

# Evolving Memory System
evolvingMemory:
  enabled: true
  maxSize: 10000
  topK: 4
  windowSize: 20
  enableRAG: true
  reMemEnabled: false
  maxInnerSteps: 5
  model: "${SUMMARY_MODEL:-gpt-4o-mini}"
  enableSmartPrune: true
  pruneThreshold: 0.95
  relevanceDecay: 0.99
  minRelevance: 0.1

# Tools configuration
enableTools: true
# allowTools: []  # Empty = all tools enabled

# Kafka (agent tools)
kafka:
  brokers: "${KAFKA_BROKERS:-kafka:29092}"
  commandsTopic: "manifold.orchestrator.commands"
  responsesTopic: "manifold.orchestrator.responses"

# MCP Servers (optional)
mcp:
  servers: []

# Specialists (optional)
specialists: []
specialistRoutes: []
